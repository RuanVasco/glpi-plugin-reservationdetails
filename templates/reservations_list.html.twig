{% import "components/form/fields_macros.html.twig" as fields %}

<div class="ms-3">
    <label for="porLista" class="form-label">Mostrar reservas</label>
    <div style="width: 20vw">
        <select class="form-select" id="porLista">
            <option value="open">Em aberto</option>
            <option value="closed">Fechadas</option>
        </select>
    </div>
</div>

<table class="w-100 text-center mt-3 table table-striped">
    <thead>
        <tr>
            {% if view == 'true' %}
                <th>Ver</th>
            {% endif %}        
            <th class="sortable" data-sort="item" style="cursor: pointer;">
                Item <i class="fas fa-sort"></i>
            </th>
            <th class="sortable" data-sort="user" style="cursor: pointer;">
                Usuário <i class="fas fa-sort"></i>
            </th>
            <th class="sortable" data-sort="begin" style="cursor: pointer;">
                Início <i class="fas fa-sort-down"></i>
            </th>
            <th class="sortable" data-sort="end" style="cursor: pointer;">
                Fim <i class="fas fa-sort"></i>
            </th>
        </tr>
    </thead>
    <tbody id="reservations_table_body">               
        {% for value in values %}
            <tr>     
                {% if view == 'true' %}
                    <td>
                        <button 
                            type="button"
                            class="btn btn-primary"
                            value="{{value.id}}"
                            data-bs-toggle="modal"
                            data-bs-target="#reservationModal"
                            onclick="showFormModal(this)"
                        ><i class="fas fa-eye"></i></button>
                    </td>
                {% endif %}
                <td>{{ value.item }}</td>
                <td>{{ value.user }}</td>
                <td>{{ value.begin }}</td>
                <td>{{ value.end }}</td>
            </tr>
        {% endfor %}        
    </tbody>
</table>

<nav aria-label="Pagination" class="ms-3">
    <ul class="pagination" id="paginationControls">
        <li class="page-item {% if currentPage <= 1 %}disabled{% endif %}">
            <a class="page-link" href="#" id="prevPage">Anterior</a>
        </li>
        <li class="page-item disabled">
            <span class="page-link" id="pageInfo">Página {{ currentPage }} de {{ totalPages }} ({{ totalCount }} registros)</span>
        </li>
        <li class="page-item {% if currentPage >= totalPages %}disabled{% endif %}">
            <a class="page-link" href="#" id="nextPage">Próxima</a>
        </li>
    </ul>
</nav>

<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title">Reserva</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    let currentPage = {{ currentPage }};
    let totalPages = {{ totalPages }};
    let currentStatus = 'open';
    let sortField = 'begin';
    let sortDir = 'DESC';

    function loadReservations(page, status) {
        var ajaxUrl = (typeof CFG_GLPI !== 'undefined' ? CFG_GLPI.root_doc : '') + "/plugins/reservationdetails/ajax/reservations.php";
        
        $.ajax({
            url: ajaxUrl,
            type: "GET",
            data: {
                byList: status,
                page: page,
                sortField: sortField,
                sortDir: sortDir
            },
            dataType: "json",
            success: function(response) {
                let table = $("#reservations_table_body");
                table.empty();

                if (response.data && response.data.length > 0) {
                    currentPage = response.currentPage;
                    totalPages = response.totalPages;
                    sortField = response.sortField;
                    sortDir = response.sortDir;

                    response.data.forEach((c) => {
                        table.append(`
                            <tr>                     
                                <td>
                                    <button 
                                        type="button"
                                        class="btn btn-primary"
                                        value="${c.id}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#reservationModal"
                                        onclick="showFormModal(this)"
                                    ><i class="fas fa-eye"></i></button>
                                </td>               
                                <td>${c.item}</td>
                                <td>${c.user}</td>
                                <td>${c.begin}</td>
                                <td>${c.end}</td>
                            </tr>                    
                        `);
                    });
                } else {
                    table.append('<tr><td colspan="5" class="text-center">Nenhuma reserva encontrada</td></tr>');
                }

                updatePaginationControls(response);
                updateSortIcons();
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                $("#reservations_table_body").html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar reservas</td></tr>');
            }
        });
    }

    function updateSortIcons() {
        $(".sortable i").removeClass("fa-sort-up fa-sort-down").addClass("fa-sort");
        $(`.sortable[data-sort="${sortField}"] i`)
            .removeClass("fa-sort")
            .addClass(sortDir === 'ASC' ? 'fa-sort-up' : 'fa-sort-down');
    }

    function updatePaginationControls(response) {
        $("#pageInfo").text(`Página ${response.currentPage} de ${response.totalPages} (${response.totalCount} registros)`);
        
        if (response.currentPage <= 1) {
            $("#prevPage").parent().addClass("disabled");
        } else {
            $("#prevPage").parent().removeClass("disabled");
        }
        
        if (response.currentPage >= response.totalPages) {
            $("#nextPage").parent().addClass("disabled");
        } else {
            $("#nextPage").parent().removeClass("disabled");
        }
    }

    $("#porLista").on("change", (e) => {
        currentStatus = $("#porLista").val();
        currentPage = 1;
        loadReservations(1, currentStatus);
    });

    $("#prevPage").on("click", (e) => {
        e.preventDefault();
        if (currentPage > 1) {
            loadReservations(currentPage - 1, currentStatus);
        }
    });

    $("#nextPage").on("click", (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
            loadReservations(currentPage + 1, currentStatus);
        }
    });

    $(".sortable").on("click", function() {
        let newSort = $(this).data("sort");
        if (newSort === sortField) {
            sortDir = sortDir === 'ASC' ? 'DESC' : 'ASC';
        } else {
            sortField = newSort;
            sortDir = 'DESC';
        }
        currentPage = 1;
        loadReservations(1, currentStatus);
    });

    function showFormModal(e) {  
        $.get(
            CFG_GLPI.root_doc + "/plugins/reservationdetails/ajax/reservations.php",
            {
                id: e.value,                
            },
            function(response) {
                let table = $('<table>').addClass('w-100');

                let rows = `
                    <tr>
                        <td>Usuário</td>
                        <td>${response.user}</td>
                    </tr>
                    <tr>
                        <td>Item</td>
                        <td>${response.itemName}</td>
                    </tr>
                    <tr>
                        <td>Início</td>
                        <td>${response.begin}</td>
                    </tr>
                    <tr>
                        <td>Fim</td>
                        <td>${response.end}</td>
                    </tr>
                    <tr>
                        <td>Comentário</td>
                        <td>${response.comment}</td>
                    </tr>`;

                if (response.recursos && response.recursos.length > 0) { 
                    rows += `
                            <tr>
                                <td class="align-text-top">Recursos</td>
                                <td><ul>`;
                    response.recursos.forEach((recurso) => {
                        rows += `<li>${recurso.name}</li>`;
                    });                               
                                    
                    rows += `</ul></td></tr>`;                 
                }

                // Display custom fields
                if (response.customFields && response.customFields.length > 0) {
                    response.customFields.forEach((field) => {
                        rows += `
                            <tr>
                                <td>${field.label}</td>
                                <td>${field.value}</td>
                            </tr>`;
                    });
                }

                table.html(rows);
                $("#modalBody").empty().append(table);
            }
        );
    }
</script>

